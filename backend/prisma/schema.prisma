generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PlanetType {
  DESERT
  ICE
  FOREST
  CITY
  VOLCANO
  JUNGLE
  VOLCANIC
  TERRAN
}

// Blueprint System Enums
enum ModuleCategory {
  HYPERDRIVE       // Hyperantrieb, Reichweite
  SUBLIGHT_ENGINE  // Sublicht-Antrieb, Geschwindigkeit
  WEAPONS          // Turbolaser, Ionenkanonen, Protonenraketen
  SHIELDS          // Deflektorschild-Generatoren
  SENSORS          // Scanner, Zielerfassung
  CARGO            // Frachtraum
  LIFE_SUPPORT     // Lebenserhaltung, Crew-Kapazitaet
  HULL             // Huellen-Panzerung
  TRACTOR_BEAM     // Traktorstrahl
  SPECIAL          // Spezialmodule (Tarnvorrichtung etc.)
}

enum ShipClass {
  FIGHTER          // Jaeger (TIE, X-Wing)
  BOMBER           // Bomber (Y-Wing, TIE-Bomber)
  CORVETTE         // Korvette (CR90)
  FRIGATE          // Fregatte (Nebulon-B)
  CRUISER          // Kreuzer (Dreadnaught)
  CAPITAL          // Grosskapitaeler (Sternzerstoerer)
  TRANSPORT        // Transporter (GR-75)
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  username  String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  player          Player?
  inviteCodes     InviteCode[]  @relation("UserInviteCodes")
  usedInviteCode  InviteCode?   @relation("UsedInviteCode", fields: [usedInviteCodeId], references: [id])
  usedInviteCodeId Int?
}

model Player {
  id            Int      @id @default(autoincrement())
  userId        Int      @unique
  factionId     Int
  allianceId    Int?
  isAdmin       Boolean  @default(false)
  createdAt     DateTime @default(now())

  user          User       @relation(fields: [userId], references: [id])
  faction       Faction    @relation(fields: [factionId], references: [id])
  alliance      Alliance?  @relation(fields: [allianceId], references: [id])
  planets       Planet[]
  ships         Ship[]
  research      PlayerResearch[]
  fleets        Fleet[]
  holonetMessages HoloNetMessage[]
  blueprints    ShipBlueprint[]
}

model Faction {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String
  
  players     Player[]
  startPlanets StartPlanet[]
}

model Alliance {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  tag         String   @unique
  founderId   Int
  createdAt   DateTime @default(now())
  
  members     Player[]
}

model Galaxy {
  id          Int      @id @default(autoincrement())
  name        String
  sizeX       Int
  sizeY       Int
  
  sectors     Sector[]
}

model Sector {
  id          Int      @id @default(autoincrement())
  galaxyId    Int
  x           Int
  y           Int
  sectorType  String   // NORMAL, NEBULA, ASTEROID_FIELD
  
  galaxy      Galaxy   @relation(fields: [galaxyId], references: [id])
  systems     System[]
  
  @@unique([galaxyId, x, y])
}

model System {
  id          Int      @id @default(autoincrement())
  name        String
  sectorId    Int
  systemType  String   // SINGLE_STAR, BINARY_STAR, NEUTRON_STAR, BLACK_HOLE
  fieldX      Int      // X-coordinate in sector (1-20)
  fieldY      Int      // Y-coordinate in sector (1-20)
  gridSize    Int      @default(30) // Grid size for system view (20-40)
  
  sector      Sector   @relation(fields: [sectorId], references: [id])
  planets     Planet[]
  ships       Ship[]   // Ships currently in this system
  
  @@unique([sectorId, fieldX, fieldY])
}

model Planet {
  id              Int        @id @default(autoincrement())
  name            String
  systemId        Int        // Planet belongs to a System now
  playerId        Int?
  planetType      PlanetType @default(TERRAN) // Now using Enum
  visualSeed      Int?       // For visual variations (1-N)
  orbitRadius     Int        @default(3) // Distance from sun (1-10)
  orbitAngle      Int        @default(0) // Position on orbit (0-359 degrees)
  sizeX           Int        @default(10)
  sizeY           Int        @default(10)
  credits         Int        @default(10000)
  durastahl       Int        @default(500)
  kristallinesSilizium Int   @default(500)
  tibannaGas      Int        @default(0)
  energiemodule   Int        @default(0)
  kyberKristalle  Int        @default(0)
  bacta           Int        @default(0)
  beskar          Int        @default(0)
  energyStorage   Int        @default(1000) // Start mit vollem Speicher
  energyStorageCapacity Int  @default(1000) // Max energy storage capacity
  storageCapacity Int        @default(500)  // Base storage from Command Center
  
  system      System       @relation(fields: [systemId], references: [id])
  player      Player?      @relation(fields: [playerId], references: [id])
  buildings   Building[]
  fields      PlanetField[]
  ships       Ship[]
  shipBuildQueue ShipBuildQueue[]
  blueprintBuildQueue BlueprintBuildQueue[]
}

model PlanetField {
  id          Int      @id @default(autoincrement())
  planetId    Int
  x           Int
  y           Int
  fieldLayer  String   // ORBIT, SURFACE, UNDERGROUND
  fieldType   String   // SPACE (orbit), LAND/WATER/MOUNTAIN (surface), ROCK/CRYSTAL/METAL (underground)
  buildingId  Int?
  
  planet      Planet    @relation(fields: [planetId], references: [id])
  building    Building? @relation(fields: [buildingId], references: [id])
  
  @@unique([planetId, x, y])
}

model BuildingType {
  id                Int      @id @default(autoincrement())
  name              String   @unique
  description       String
  category          String   // RESOURCE, PRODUCTION, DEFENSE, RESEARCH, STORAGE
  buildCostCredits  Int
  buildCostDurastahl Int     @default(0)
  buildCostKristallinesSilizium Int @default(0)
  buildCostTibannaGas Int    @default(0)
  buildCostEnergiemodule Int @default(0)
  buildCostKyberKristalle Int @default(0)
  buildCostBacta    Int      @default(0)
  buildCostBeskar   Int      @default(0)
  buildTime         Int      // in minutes (real-time)
  energyCostPerTick Int      @default(0)  // Energy consumed per tick when active
  energyCostToBuild Int      @default(0)  // Energy required to start construction
  energyProduction  Int      @default(0)
  durastahlProduction Int    @default(0)
  kristallinesSiliziumProduction Int @default(0)
  tibannaGasProduction Int   @default(0)
  energiemoduleProduction Int @default(0)
  kyberKristalleProduction Int @default(0)
  bactaProduction   Int      @default(0)
  beskarProduction  Int      @default(0)
  creditProduction  Int      @default(0)
  storageBonus      Int      @default(0)
  requiredResearch  Int?
  
  buildings         Building[]
}

model Building {
  id                     Int      @id @default(autoincrement())
  planetId               Int
  buildingTypeId         Int
  level                  Int      @default(1)
  isActive               Boolean  @default(false)
  constructionStartedAt  DateTime @default(now())
  completedAt            DateTime?
  
  planet                 Planet       @relation(fields: [planetId], references: [id])
  buildingType           BuildingType @relation(fields: [buildingTypeId], references: [id])
  fields                 PlanetField[]
}

model ResearchType {
  id                    Int      @id @default(autoincrement())
  name                  String   @unique
  description           String
  category              String   // MILITARY, ECONOMICS, SCIENCE, ENERGY
  researchLevel         Int      @default(0)  // 0, 1, 2, 3
  researchPointCost     Int      @default(0)  // FP cost (0 for Level 0)
  researchTime          Int      @default(0)  // Deprecated, using FP now

  // Level 0 requirements (production-based)
  requiredCreditsPerTick  Int?
  requiredDurastahlPerTick Int?
  requiredKristallinesSiliziumPerTick Int?
  requiredEnergyPerTick   Int?

  // Level 0 total accumulation requirements (for tick-based research)
  requiredCreditsTotal    Int?  // Total credits needed to complete
  requiredDurastahlTotal  Int?  // Total durastahl needed to complete
  requiredKristallinesSiliziumTotal Int?  // Total kristallines silizium needed to complete
  requiredEnergyTotal     Int?  // Total energy needed to complete

  // Level 1+ requirements
  requiredLabCount      Int      @default(0)  // Minimum research labs needed
  prerequisiteId        Int?

  // What it unlocks
  unlocksBuilding       String?  // BuildingType name
  unlocksBuildingId     Int?     // Direct reference
  unlocksShip           String?  // ShipType name
  bonusType             String?  // PRODUCTION_BONUS, COMBAT_BONUS, etc.
  bonusValue            Int      @default(0)

  prerequisite          ResearchType?  @relation("ResearchPrerequisite", fields: [prerequisiteId], references: [id])
  dependents            ResearchType[] @relation("ResearchPrerequisite")
  playerResearch        PlayerResearch[]
  unlockedModules       ModuleType[]   // Module die durch diese Forschung freigeschaltet werden
}

model PlayerResearch {
  id              Int      @id @default(autoincrement())
  playerId        Int
  researchTypeId  Int
  currentProgress Int      @default(0)  // Accumulated FP or resources
  maxProgress     Int      @default(0)  // Total required (FP or resources)
  startedAt       DateTime?
  completedAt     DateTime?

  player          Player       @relation(fields: [playerId], references: [id])
  researchType    ResearchType @relation(fields: [researchTypeId], references: [id])

  @@unique([playerId, researchTypeId])
}

// =====================================================
// MODULARES SCHIFFSBAU-SYSTEM (Blueprint System)
// =====================================================

model ModuleType {
  id                    Int            @id @default(autoincrement())
  name                  String         @unique  // z.B. "Klasse-1 Hyperantrieb", "Turbolaser Mk.I"
  description           String
  category              ModuleCategory
  maxLevel              Int            @default(10)

  // Basis-Stats pro Level (werden mit Level multipliziert/skaliert)
  baseHullPoints        Int            @default(0)   // Huellenpunkte
  baseDamage            Int            @default(0)   // Schaden
  baseShieldStrength    Int            @default(0)   // Deflektorschild-Staerke
  baseSensorRange       Int            @default(0)   // Sensorreichweite
  baseCargoCapacity     Int            @default(0)   // Frachtraum
  baseCrewCapacity      Int            @default(0)   // Crew-Kapazitaet
  baseSpeed             Int            @default(0)   // Sublicht-Geschwindigkeit

  // Star Wars spezifische Stats
  hyperdriveRating      Float?                       // 1.0 = Standard, 0.5 = schneller (kleiner = besser)
  tibannaConsumption    Int            @default(0)   // Tibanna-Gas Verbrauch pro Schuss/Aktion

  // Kosten-Basis (exponentiell skaliert mit Level)
  baseCostCredits       Int            @default(0)
  baseCostDurastahl     Int            @default(0)
  baseCostKyberKristalle Int           @default(0)
  baseCostTibannaGas    Int            @default(0)
  baseCostBeskar        Int            @default(0)
  baseCostKristallinesSilizium Int     @default(0)
  baseCostEnergiemodule Int            @default(0)

  // Bauzeit-Basis in Minuten (skaliert mit Level)
  baseBuildTime         Int            @default(5)

  // Freischaltung durch Forschung
  requiredResearchId    Int?
  requiredResearchLevel Int            @default(1)   // Mindest-Level der Forschung

  requiredResearch      ResearchType?  @relation(fields: [requiredResearchId], references: [id])
  blueprintModules      BlueprintModule[]
}

model ShipBlueprint {
  id          Int        @id @default(autoincrement())
  playerId    Int
  name        String                               // z.B. "Mein Custom X-Wing"
  shipClass   ShipClass                            // FIGHTER, CORVETTE, FRIGATE, etc.
  description String?
  isPublic    Boolean    @default(false)           // Kann von anderen kopiert werden
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Berechnete Gesamt-Stats (gecached fuer Performance)
  totalHullPoints           Int     @default(0)
  totalShieldStrength       Int     @default(0)   // deflectorShieldStrength
  totalDamage               Int     @default(0)   // weaponDamage
  totalSpeed                Int     @default(0)   // subLightSpeed
  totalSensorRange          Int     @default(0)
  totalCargoCapacity        Int     @default(0)
  totalCrewRequired         Int     @default(0)
  hyperdriveRating          Float   @default(1.0) // Effektives Hyperdrive-Rating

  // Berechnete Kosten (gecached)
  totalCostCredits          Int     @default(0)
  totalCostDurastahl        Int     @default(0)
  totalCostKyberKristalle   Int     @default(0)
  totalCostTibannaGas       Int     @default(0)
  totalCostBeskar           Int     @default(0)
  totalCostKristallinesSilizium Int @default(0)
  totalCostEnergiemodule    Int     @default(0)
  totalBuildTime            Int     @default(0)   // Gesamte Bauzeit in Minuten

  player      Player            @relation(fields: [playerId], references: [id])
  modules     BlueprintModule[]
  ships       Ship[]
  buildQueue  BlueprintBuildQueue[]

  @@unique([playerId, name])
}

model BlueprintModule {
  id            Int      @id @default(autoincrement())
  blueprintId   Int
  moduleTypeId  Int
  level         Int      @default(1)              // Level des Moduls (1-maxLevel)
  slotPosition  Int                               // Position/Slot im Schiff (1-10)

  blueprint     ShipBlueprint @relation(fields: [blueprintId], references: [id], onDelete: Cascade)
  moduleType    ModuleType    @relation(fields: [moduleTypeId], references: [id])

  @@unique([blueprintId, slotPosition])
}

model BlueprintBuildQueue {
  id                     Int       @id @default(autoincrement())
  planetId               Int
  blueprintId            Int
  quantity               Int       @default(1)
  constructionStartedAt  DateTime  @default(now())
  completedAt            DateTime?

  planet                 Planet        @relation(fields: [planetId], references: [id])
  blueprint              ShipBlueprint @relation(fields: [blueprintId], references: [id])
}

// =====================================================

model ShipType {
  id                      Int      @id @default(autoincrement())
  name                    String   @unique
  description             String
  shipClass               String   // FIGHTER, BOMBER, CORVETTE, FRIGATE, CRUISER, CAPITAL, TRANSPORT
  buildCost               Int
  buildCostDurastahl      Int      @default(0)
  buildCostKristallinesSilizium Int @default(0)
  buildCostTibannaGas     Int      @default(0)
  buildCostEnergiemodule  Int      @default(0)
  buildCostKyberKristalle Int      @default(0)
  buildCostBacta          Int      @default(0)
  buildCostBeskar         Int      @default(0)
  buildTime               Int      // in minutes
  crewRequired            Int
  cargoCapacity           Int
  fuelCapacity            Int
  speed                   Int
  attack                  Int
  defense                 Int
  requiredResearch        Int?
  sensorRange             Int      @default(3)  // Sensor radius in fields
  driveEfficiency         Int      @default(1) // Energy cost per field (always 1)
  maxEnergyWeapons        Int      @default(50) // Max weapon/shield energy
  maxEnergyDrive          Int      @default(50) // Max hyperdrive energy (50 fields range)
  
  ships                   Ship[]
  shipBuildQueue          ShipBuildQueue[]
}

model Ship {
  id              Int      @id @default(autoincrement())
  playerId        Int      // Owner of the ship
  fleetId         Int?
  shipTypeId      Int?     // Legacy: deprecated, use blueprintId instead
  blueprintId     Int?     // NEU: Relation zum Blueprint
  planetId        Int?     // Where it was built / is stationed (when DOCKED)
  name            String?
  crew            Int      @default(0)

  // Position & Movement (STU-Style)
  currentGalaxyX  Int?     // Position on 120x120 hyperspace map
  currentGalaxyY  Int?
  currentSystemX  Int?     // Position inside a system (if entered)
  currentSystemY  Int?
  currentSystemId Int?     // Which system the ship is in
  status          String   @default("DOCKED") // DOCKED, IN_FLIGHT, STRANDED
  destinationX    Int?     // Target coordinates for auto-flight
  destinationY    Int?

  // Energy (STU-Style: separate for weapons and drive)
  energyWeapons   Int      @default(0)   // Current energy for weapons/shields
  energyDrive     Int      @default(0)   // Current energy for hyperdrive (determines range)

  // Finale Stats (vom Blueprint berechnet) - Star Wars thematisch
  hullPoints              Int     @default(100)  // Huellenpunkte (ersetzt health)
  deflectorShieldStrength Int     @default(0)    // Deflektorschild-Staerke
  weaponDamage            Int     @default(10)   // Waffenschaden
  subLightSpeed           Int     @default(5)    // Sublicht-Geschwindigkeit
  hyperdriveRating        Float   @default(1.0)  // Hyperdrive-Klasse (kleiner = schneller)
  sensorRange             Int     @default(3)    // Sensorreichweite
  cargoCapacity           Int     @default(100)  // Frachtraum-Kapazitaet
  crewCapacity            Int     @default(10)   // Crew-Kapazitaet

  player          Player         @relation(fields: [playerId], references: [id])
  fleet           Fleet?         @relation(fields: [fleetId], references: [id])
  shipType        ShipType?      @relation(fields: [shipTypeId], references: [id])
  blueprint       ShipBlueprint? @relation(fields: [blueprintId], references: [id])
  planet          Planet?        @relation(fields: [planetId], references: [id])
  system          System?        @relation(fields: [currentSystemId], references: [id])
}

model ShipBuildQueue {
  id                     Int      @id @default(autoincrement())
  planetId               Int
  shipTypeId             Int
  quantity               Int      @default(1)
  constructionStartedAt  DateTime @default(now())
  completedAt            DateTime?
  
  planet                 Planet   @relation(fields: [planetId], references: [id])
  shipType               ShipType @relation(fields: [shipTypeId], references: [id])
}

model Fleet {
  id              Int      @id @default(autoincrement())
  playerId        Int
  name            String
  sectorId        Int?
  status          String   @default("IDLE") // IDLE, MOVING, IN_COMBAT
  
  player          Player   @relation(fields: [playerId], references: [id])
  ships           Ship[]
}

model StartPlanet {
  id          Int      @id @default(autoincrement())
  factionId   Int
  planetName  String   @unique
  sectorX     Int
  sectorY     Int
  
  faction     Faction  @relation(fields: [factionId], references: [id])
}

model GameTick {
  id          Int      @id @default(autoincrement())
  tickNumber  Int      @unique
  processedAt DateTime @default(now())
}

model InviteCode {
  id          Int       @id @default(autoincrement())
  code        String    @unique
  createdById Int?
  usedById    Int?
  isUsed      Boolean   @default(false)
  createdAt   DateTime  @default(now())
  usedAt      DateTime?
  
  createdBy   User?     @relation("UserInviteCodes", fields: [createdById], references: [id])
  usedBy      User[]    @relation("UsedInviteCode")
}

model HoloNetMessage {
  id        Int      @id @default(autoincrement())
  playerId  Int
  title     String?
  message   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  
  player    Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  @@index([createdAt])
}
